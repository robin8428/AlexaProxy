package proxy.alexa;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

import java.time.Instant;
import java.time.format.DateTimeFormatter;

import org.assertj.core.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.web.util.NestedServletException;
import org.zalando.fauxpas.FauxPas;

import proxy.AlexaProxy;
import proxy.util.TestUtils;


@SpringBootTest(classes = {
		AlexaProxy.class,
		TestUtils.class })
@AutoConfigureMockMvc
@ActiveProfiles("test")
public class AlexaControllerTest {

	@Autowired
	private MockMvc mvc;
	@Autowired
	TestUtils testUtils;

	@Test
	public void testSignatureVerifier() {
		testUtils.runWithEnabledSignatureValidationAndDisabledTimestampValidation(FauxPas.throwingRunnable(() -> {
			mvc.perform(post("/alexa")
					.contentType("application/json; charset=utf-8")
					.header("signature", "duKs1oLTDXKnO2P16VM+hkgsg/M4cn9U9+P/i8f1PI828iwFWVjAcqzll1VJ9D3aHUBEbXSr6XxqGquyuJOmR5ZSPitm1JpsXshB91PxxqgE1gT7BQLZvkwUNU6ubmgjvqdsHbt9yDiIfmOlSOSvzoL2GH9k/NewwrHEJw4LeZY5/FIC0DKD0khyjR1OgnfRzHRkQeT8LiqCEbnByDoFkRA861+Nq5XkwpOE/gbJ/ZItLp7tx9B4xXSUoDqxV4H7rA0+X6frU1Pc2gJ4cgbvgt76h81QRIlJdIxEXgeA2Xl5ntP3098ZCtmfpGXKIY3EdrEZu6/9Xni5z2DCGoJAPQ==")
					.header("signature-256", "Ul9P2CcF0+EnSBCnnAFowIVtjPAj4CvuUnf0PycA+GRoH1AyGDQVRIVJUfC1MWPhGLOK6ab3toVD2jbSQoVyErr55XAub37Wz8RyMIXJPXNWkd5wTyhCVpJhYwQdrcngsOYDILEmyIPH+FnCJUz5PY7oraWZu6UExj0k9NiCwOHDmjro2r8KcROLfc85/MPooOsViwJ0Z3JEcSL0H5gQJwLWcTgbBkvrgsOaPl7RNgCBWZ7YTFGeVsQnDSIbyv3/aheOg9ryuXhm7HKvo+DigaT4Thwox2kM4rrXF3gzkU5013f9OqtGP83aVoQTfnFEZkSNIjUOQ6enpr5nUq1EeQ==")
					.header("signaturecertchainurl", "https://s3.amazonaws.com/echo.api/echo-api-cert-11.pem")
					.content("{\"version\":\"1.0\",\"session\":{\"new\":true,\"sessionId\":\"amzn1.echo-api.session.7dec95a6-a909-41ea-bf06-618abc70aba4\",\"application\":{\"applicationId\":\"amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11\"},\"attributes\":{},\"user\":{\"userId\":\"amzn1.ask.account.AF7KDMGMX5QRW3AL6MBCOOFFRUMYMI7WJPKP6LI6T3JEF72ROHTKMGKOMQOA33CEQB3OEATRNLKGKTXFDISXNDF6QPD7G74EWAF3NGZHKTGNWD4NKIJ4SAETZFD5EPU3ZEDFGEECFTLN7EZ2MHLZ2T2XZWSKUO5HXPVP2IEQW7ZEFIUFL5GAAQX5UJ5OBPXAC264BMD5PP7OBWI\"}},\"context\":{\"Viewports\":[{\"type\":\"APL\",\"id\":\"TabletFullScreen_0\",\"shape\":\"RECTANGLE\",\"dpi\":213,\"presentationType\":\"STANDARD\",\"canRotate\":true,\"configuration\":{\"current\":{\"mode\":\"MOBILE\",\"video\":{\"codecs\":[\"H_264_42\",\"H_264_41\"]},\"size\":{\"type\":\"DISCRETE\",\"pixelWidth\":800,\"pixelHeight\":1280}}}}],\"Viewport\":{\"experiences\":[{\"arcMinuteWidth\":4195,\"arcMinuteHeight\":1161,\"canRotate\":true,\"canResize\":true}],\"mode\":\"MOBILE\",\"shape\":\"RECTANGLE\",\"pixelWidth\":1280,\"pixelHeight\":800,\"dpi\":213,\"currentPixelWidth\":800,\"currentPixelHeight\":1280,\"touch\":[\"SINGLE\"],\"keyboard\":[\"DIRECTION\"],\"video\":{\"codecs\":[\"H_264_42\",\"H_264_41\"]}},\"Extensions\":{\"available\":{\"aplext:backstack:10\":{}}},\"System\":{\"application\":{\"applicationId\":\"amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11\"},\"user\":{\"userId\":\"amzn1.ask.account.AF7KDMGMX5QRW3AL6MBCOOFFRUMYMI7WJPKP6LI6T3JEF72ROHTKMGKOMQOA33CEQB3OEATRNLKGKTXFDISXNDF6QPD7G74EWAF3NGZHKTGNWD4NKIJ4SAETZFD5EPU3ZEDFGEECFTLN7EZ2MHLZ2T2XZWSKUO5HXPVP2IEQW7ZEFIUFL5GAAQX5UJ5OBPXAC264BMD5PP7OBWI\"},\"device\":{\"deviceId\":\"amzn1.ask.device.AEEQDYOJLR56EVA4KFYMAHYDWQIQ7PKMJ4IKSMUIUVH4GPKFXMOAELUIUOPU6V7SAH5R4VX4AOEYUHKPLW43KIMAEHX77FEVFK75MPPEW73UCXCLNOXBJQM3VBMYH3KSJQP64XG227F2PLD6NFKVHWP2O66BSTROSFRAYTBF44ET2V2TVFN5C\",\"supportedInterfaces\":{\"Geolocation\":{}}},\"apiEndpoint\":\"https://api.eu.amazonalexa.com\",\"apiAccessToken\":\"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IjEifQ.eyJhdWQiOiJodHRwczovL2FwaS5ldS5hbWF6b25hbGV4YS5jb20iLCJpc3MiOiJBbGV4YVNraWxsS2l0Iiwic3ViIjoiYW16bjEuYXNrLnNraWxsLjM0ODM2NDdhLWU3NjQtNGFiNS05MDBjLTdjMmMxN2U0NmIxMSIsImV4cCI6MTY2NTA4MDc1NywiaWF0IjoxNjY1MDgwNDU3LCJuYmYiOjE2NjUwODA0NTcsInByaXZhdGVDbGFpbXMiOnsiY29udGV4dCI6IkFBQUFBQUFBQVFBUytXcXJYT1BSWHJqR29UVFcvSUhHS3dFQUFBQUFBQUI0NTlYeEZZcmQ0UnMvbUdLMDd1NUV3ZVhzOEpyVEUxVlQxdDBqbVI0aDNzMTJyay9LMmdNTm1tY2I2Z0V0VXBUaEFnMzJ6c3o1UHpaWjZxSXRDSnowNnJvbUc1WHg0ZzM4RzdIelZMU3pQMUlGY295YnZqdC9kUWU0MDdrUkNRWjNmQkZiem5xTTRmRkRhNnlGZVdtY3hFNXlsTFRrbHhPZWNjV2E0M2lCZU90Ym5MNXM4L29JMVRDY05OMVhzRE02MXpULzI3cjNNcktISkd2Nk9DK2xRRXBneDlWOGNzeWVnTnNUMUlxMkhYS2hJK3ZqVkNZS0REUDdGaSt2K2dHSEdObTNOOHJ6ZlpkMk5WZU1XRWxDeVhybnkvZzI3ZEhpR2JGWmRCaWs2NmZRUHV6K0hoOFNzNU5sRnhWU25HbTlKcTR0ZmtydURBYzc4VFZZRnR0TVRpYjZMOHpoUWlrbXpUTjNuRHhDQm0yQ0w3TVNndXJVbS91YWRINER5Z2JxV2pvZnFNU05iSnRxbEE9PSIsImRldmljZUlkIjoiYW16bjEuYXNrLmRldmljZS5BRUVRRFlPSkxSNTZFVkE0S0ZZTUFIWURXUUlRN1BLTUo0SUtTTVVJVVZINEdQS0ZYTU9BRUxVSVVPUFU2VjdTQUg1UjRWWDRBT0VZVUhLUExXNDNLSU1BRUhYNzdGRVZGSzc1TVBQRVc3M1VDWENMTk9YQkpRTTNWQk1ZSDNLU0pRUDY0WEcyMjdGMlBMRDZORktWSFdQMk82NkJTVFJPU0ZSQVlUQkY0NEVUMlYyVFZGTjVDIiwidXNlcklkIjoiYW16bjEuYXNrLmFjY291bnQuQUY3S0RNR01YNVFSVzNBTDZNQkNPT0ZGUlVNWU1JN1dKUEtQNkxJNlQzSkVGNzJST0hUS01HS09NUU9BMzNDRVFCM09FQVRSTkxLR0tUWEZESVNYTkRGNlFQRDdHNzRFV0FGM05HWkhLVEdOV0Q0TktJSjRTQUVUWkZENUVQVTNaRURGR0VFQ0ZUTE43RVoyTUhMWjJUMlhaV1NLVU81SFhQVlAySUVRVzdaRUZJVUZMNUdBQVFYNVVKNU9CUFhBQzI2NEJNRDVQUDdPQldJIn19.Y_uPPN8X2IJm0tI5eJZG_IbJnfkCdTXyH9qYKcVrp95OxvtdwFQKXN1WbshGLoXAQQGvr6jkNXceG7mj3rH_7qh5Erxg1c8bXzrCbOyVui9LmP9b11RuP85ZsPL2OFA0TIiYQ-cxMPWg6DKkK2Ml9b5jMBBlvJMBYzJv7CEjGdmVuKyp_Bm5VbQlPmqvuUs6Nh3R00L7zbiH0G9D1NmDvt7gsn4Rcy_V1coRUUmtMhNbjVMUdkc54LFLfiDRwlsIx86XtlFnFCT4FtHbSLap3tvQo2Z3tXVi3J4Ks5AGg2uw4YDWkPxkkLYapxhnujujYQOPspPknoSVCKcC5E3f9g\"}},\"request\":{\"type\":\"IntentRequest\",\"requestId\":\"amzn1.echo-api.request.3b6cd82e-4026-4567-9ded-124c4bed476e\",\"locale\":\"de-DE\",\"timestamp\":\"2022-10-06T18:20:57Z\",\"intent\":{\"name\":\"LightIntent\",\"confirmationStatus\":\"NONE\",\"slots\":{\"room\":{\"name\":\"room\",\"value\":\"schwarzlicht\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.ROOM\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"blacklight\",\"id\":\"blacklight\"}}]}]},\"confirmationStatus\":\"NONE\",\"source\":\"USER\",\"slotValue\":{\"type\":\"Simple\",\"value\":\"schwarzlicht\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.ROOM\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"blacklight\",\"id\":\"blacklight\"}}]}]}}},\"status\":{\"name\":\"status\",\"value\":\"an\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.STATUS\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"on\",\"id\":\"on\"}}]}]},\"confirmationStatus\":\"NONE\",\"source\":\"USER\",\"slotValue\":{\"type\":\"Simple\",\"value\":\"an\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.STATUS\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"on\",\"id\":\"on\"}}]}]}}}}}}}"))
					.andExpect(status().isOk());

			Assertions.assertThatThrownBy(() -> mvc.perform(post("/alexa")
					.contentType("application/json; charset=utf-8")
					.header("signature", "aaas1oLTDXKnO2P16VM+hkgsg/M4cn9U9+P/i8f1PI828iwFWVjAcqzll1VJ9D3aHUBEbXSr6XxqGquyuJOmR5ZSPitm1JpsXshB91PxxqgE1gT7BQLZvkwUNU6ubmgjvqdsHbt9yDiIfmOlSOSvzoL2GH9k/NewwrHEJw4LeZY5/FIC0DKD0khyjR1OgnfRzHRkQeT8LiqCEbnByDoFkRA861+Nq5XkwpOE/gbJ/ZItLp7tx9B4xXSUoDqxV4H7rA0+X6frU1Pc2gJ4cgbvgt76h81QRIlJdIxEXgeA2Xl5ntP3098ZCtmfpGXKIY3EdrEZu6/9Xni5z2DCGoJAPQ==")
					.header("signature-256", "aaaP2CcF0+EnSBCnnAFowIVtjPAj4CvuUnf0PycA+GRoH1AyGDQVRIVJUfC1MWPhGLOK6ab3toVD2jbSQoVyErr55XAub37Wz8RyMIXJPXNWkd5wTyhCVpJhYwQdrcngsOYDILEmyIPH+FnCJUz5PY7oraWZu6UExj0k9NiCwOHDmjro2r8KcROLfc85/MPooOsViwJ0Z3JEcSL0H5gQJwLWcTgbBkvrgsOaPl7RNgCBWZ7YTFGeVsQnDSIbyv3/aheOg9ryuXhm7HKvo+DigaT4Thwox2kM4rrXF3gzkU5013f9OqtGP83aVoQTfnFEZkSNIjUOQ6enpr5nUq1EeQ==")
					.header("signaturecertchainurl", "https://s3.amazonaws.com/echo.api/echo-api-cert-11.pem")
					.content("{\"version\":\"1.0\",\"session\":{\"new\":true,\"sessionId\":\"amzn1.echo-api.session.7dec95a6-a909-41ea-bf06-618abc70aba4\",\"application\":{\"applicationId\":\"amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11\"},\"attributes\":{},\"user\":{\"userId\":\"amzn1.ask.account.AF7KDMGMX5QRW3AL6MBCOOFFRUMYMI7WJPKP6LI6T3JEF72ROHTKMGKOMQOA33CEQB3OEATRNLKGKTXFDISXNDF6QPD7G74EWAF3NGZHKTGNWD4NKIJ4SAETZFD5EPU3ZEDFGEECFTLN7EZ2MHLZ2T2XZWSKUO5HXPVP2IEQW7ZEFIUFL5GAAQX5UJ5OBPXAC264BMD5PP7OBWI\"}},\"context\":{\"Viewports\":[{\"type\":\"APL\",\"id\":\"TabletFullScreen_0\",\"shape\":\"RECTANGLE\",\"dpi\":213,\"presentationType\":\"STANDARD\",\"canRotate\":true,\"configuration\":{\"current\":{\"mode\":\"MOBILE\",\"video\":{\"codecs\":[\"H_264_42\",\"H_264_41\"]},\"size\":{\"type\":\"DISCRETE\",\"pixelWidth\":800,\"pixelHeight\":1280}}}}],\"Viewport\":{\"experiences\":[{\"arcMinuteWidth\":4195,\"arcMinuteHeight\":1161,\"canRotate\":true,\"canResize\":true}],\"mode\":\"MOBILE\",\"shape\":\"RECTANGLE\",\"pixelWidth\":1280,\"pixelHeight\":800,\"dpi\":213,\"currentPixelWidth\":800,\"currentPixelHeight\":1280,\"touch\":[\"SINGLE\"],\"keyboard\":[\"DIRECTION\"],\"video\":{\"codecs\":[\"H_264_42\",\"H_264_41\"]}},\"Extensions\":{\"available\":{\"aplext:backstack:10\":{}}},\"System\":{\"application\":{\"applicationId\":\"amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11\"},\"user\":{\"userId\":\"amzn1.ask.account.AF7KDMGMX5QRW3AL6MBCOOFFRUMYMI7WJPKP6LI6T3JEF72ROHTKMGKOMQOA33CEQB3OEATRNLKGKTXFDISXNDF6QPD7G74EWAF3NGZHKTGNWD4NKIJ4SAETZFD5EPU3ZEDFGEECFTLN7EZ2MHLZ2T2XZWSKUO5HXPVP2IEQW7ZEFIUFL5GAAQX5UJ5OBPXAC264BMD5PP7OBWI\"},\"device\":{\"deviceId\":\"amzn1.ask.device.AEEQDYOJLR56EVA4KFYMAHYDWQIQ7PKMJ4IKSMUIUVH4GPKFXMOAELUIUOPU6V7SAH5R4VX4AOEYUHKPLW43KIMAEHX77FEVFK75MPPEW73UCXCLNOXBJQM3VBMYH3KSJQP64XG227F2PLD6NFKVHWP2O66BSTROSFRAYTBF44ET2V2TVFN5C\",\"supportedInterfaces\":{\"Geolocation\":{}}},\"apiEndpoint\":\"https://api.eu.amazonalexa.com\",\"apiAccessToken\":\"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IjEifQ.eyJhdWQiOiJodHRwczovL2FwaS5ldS5hbWF6b25hbGV4YS5jb20iLCJpc3MiOiJBbGV4YVNraWxsS2l0Iiwic3ViIjoiYW16bjEuYXNrLnNraWxsLjM0ODM2NDdhLWU3NjQtNGFiNS05MDBjLTdjMmMxN2U0NmIxMSIsImV4cCI6MTY2NTA4MDc1NywiaWF0IjoxNjY1MDgwNDU3LCJuYmYiOjE2NjUwODA0NTcsInByaXZhdGVDbGFpbXMiOnsiY29udGV4dCI6IkFBQUFBQUFBQVFBUytXcXJYT1BSWHJqR29UVFcvSUhHS3dFQUFBQUFBQUI0NTlYeEZZcmQ0UnMvbUdLMDd1NUV3ZVhzOEpyVEUxVlQxdDBqbVI0aDNzMTJyay9LMmdNTm1tY2I2Z0V0VXBUaEFnMzJ6c3o1UHpaWjZxSXRDSnowNnJvbUc1WHg0ZzM4RzdIelZMU3pQMUlGY295YnZqdC9kUWU0MDdrUkNRWjNmQkZiem5xTTRmRkRhNnlGZVdtY3hFNXlsTFRrbHhPZWNjV2E0M2lCZU90Ym5MNXM4L29JMVRDY05OMVhzRE02MXpULzI3cjNNcktISkd2Nk9DK2xRRXBneDlWOGNzeWVnTnNUMUlxMkhYS2hJK3ZqVkNZS0REUDdGaSt2K2dHSEdObTNOOHJ6ZlpkMk5WZU1XRWxDeVhybnkvZzI3ZEhpR2JGWmRCaWs2NmZRUHV6K0hoOFNzNU5sRnhWU25HbTlKcTR0ZmtydURBYzc4VFZZRnR0TVRpYjZMOHpoUWlrbXpUTjNuRHhDQm0yQ0w3TVNndXJVbS91YWRINER5Z2JxV2pvZnFNU05iSnRxbEE9PSIsImRldmljZUlkIjoiYW16bjEuYXNrLmRldmljZS5BRUVRRFlPSkxSNTZFVkE0S0ZZTUFIWURXUUlRN1BLTUo0SUtTTVVJVVZINEdQS0ZYTU9BRUxVSVVPUFU2VjdTQUg1UjRWWDRBT0VZVUhLUExXNDNLSU1BRUhYNzdGRVZGSzc1TVBQRVc3M1VDWENMTk9YQkpRTTNWQk1ZSDNLU0pRUDY0WEcyMjdGMlBMRDZORktWSFdQMk82NkJTVFJPU0ZSQVlUQkY0NEVUMlYyVFZGTjVDIiwidXNlcklkIjoiYW16bjEuYXNrLmFjY291bnQuQUY3S0RNR01YNVFSVzNBTDZNQkNPT0ZGUlVNWU1JN1dKUEtQNkxJNlQzSkVGNzJST0hUS01HS09NUU9BMzNDRVFCM09FQVRSTkxLR0tUWEZESVNYTkRGNlFQRDdHNzRFV0FGM05HWkhLVEdOV0Q0TktJSjRTQUVUWkZENUVQVTNaRURGR0VFQ0ZUTE43RVoyTUhMWjJUMlhaV1NLVU81SFhQVlAySUVRVzdaRUZJVUZMNUdBQVFYNVVKNU9CUFhBQzI2NEJNRDVQUDdPQldJIn19.Y_uPPN8X2IJm0tI5eJZG_IbJnfkCdTXyH9qYKcVrp95OxvtdwFQKXN1WbshGLoXAQQGvr6jkNXceG7mj3rH_7qh5Erxg1c8bXzrCbOyVui9LmP9b11RuP85ZsPL2OFA0TIiYQ-cxMPWg6DKkK2Ml9b5jMBBlvJMBYzJv7CEjGdmVuKyp_Bm5VbQlPmqvuUs6Nh3R00L7zbiH0G9D1NmDvt7gsn4Rcy_V1coRUUmtMhNbjVMUdkc54LFLfiDRwlsIx86XtlFnFCT4FtHbSLap3tvQo2Z3tXVi3J4Ks5AGg2uw4YDWkPxkkLYapxhnujujYQOPspPknoSVCKcC5E3f9g\"}},\"request\":{\"type\":\"IntentRequest\",\"requestId\":\"amzn1.echo-api.request.3b6cd82e-4026-4567-9ded-124c4bed476e\",\"locale\":\"de-DE\",\"timestamp\":\"2022-10-06T18:20:57Z\",\"intent\":{\"name\":\"LightIntent\",\"confirmationStatus\":\"NONE\",\"slots\":{\"room\":{\"name\":\"room\",\"value\":\"schwarzlicht\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.ROOM\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"blacklight\",\"id\":\"blacklight\"}}]}]},\"confirmationStatus\":\"NONE\",\"source\":\"USER\",\"slotValue\":{\"type\":\"Simple\",\"value\":\"schwarzlicht\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.ROOM\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"blacklight\",\"id\":\"blacklight\"}}]}]}}},\"status\":{\"name\":\"status\",\"value\":\"an\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.STATUS\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"on\",\"id\":\"on\"}}]}]},\"confirmationStatus\":\"NONE\",\"source\":\"USER\",\"slotValue\":{\"type\":\"Simple\",\"value\":\"an\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.STATUS\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"on\",\"id\":\"on\"}}]}]}}}}}}}")))
					.isInstanceOf(NestedServletException.class)
					.getCause()
					.isInstanceOf(SecurityException.class)
					.hasMessage("Failed to verify the signature/certificate for the provided skill request");
		}));
	}


	@Test
	public void testTimestampVerifier() throws Exception {
		mvc.perform(post("/alexa")
				.contentType("application/json; charset=utf-8")
				.content("{\"version\":\"1.0\",\"session\":{\"new\":true,\"sessionId\":\"amzn1.echo-api.session.7dec95a6-a909-41ea-bf06-618abc70aba4\",\"application\":{\"applicationId\":\"amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11\"},\"attributes\":{},\"user\":{\"userId\":\"amzn1.ask.account.AF7KDMGMX5QRW3AL6MBCOOFFRUMYMI7WJPKP6LI6T3JEF72ROHTKMGKOMQOA33CEQB3OEATRNLKGKTXFDISXNDF6QPD7G74EWAF3NGZHKTGNWD4NKIJ4SAETZFD5EPU3ZEDFGEECFTLN7EZ2MHLZ2T2XZWSKUO5HXPVP2IEQW7ZEFIUFL5GAAQX5UJ5OBPXAC264BMD5PP7OBWI\"}},\"context\":{\"Viewports\":[{\"type\":\"APL\",\"id\":\"TabletFullScreen_0\",\"shape\":\"RECTANGLE\",\"dpi\":213,\"presentationType\":\"STANDARD\",\"canRotate\":true,\"configuration\":{\"current\":{\"mode\":\"MOBILE\",\"video\":{\"codecs\":[\"H_264_42\",\"H_264_41\"]},\"size\":{\"type\":\"DISCRETE\",\"pixelWidth\":800,\"pixelHeight\":1280}}}}],\"Viewport\":{\"experiences\":[{\"arcMinuteWidth\":4195,\"arcMinuteHeight\":1161,\"canRotate\":true,\"canResize\":true}],\"mode\":\"MOBILE\",\"shape\":\"RECTANGLE\",\"pixelWidth\":1280,\"pixelHeight\":800,\"dpi\":213,\"currentPixelWidth\":800,\"currentPixelHeight\":1280,\"touch\":[\"SINGLE\"],\"keyboard\":[\"DIRECTION\"],\"video\":{\"codecs\":[\"H_264_42\",\"H_264_41\"]}},\"Extensions\":{\"available\":{\"aplext:backstack:10\":{}}},\"System\":{\"application\":{\"applicationId\":\"amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11\"},\"user\":{\"userId\":\"amzn1.ask.account.AF7KDMGMX5QRW3AL6MBCOOFFRUMYMI7WJPKP6LI6T3JEF72ROHTKMGKOMQOA33CEQB3OEATRNLKGKTXFDISXNDF6QPD7G74EWAF3NGZHKTGNWD4NKIJ4SAETZFD5EPU3ZEDFGEECFTLN7EZ2MHLZ2T2XZWSKUO5HXPVP2IEQW7ZEFIUFL5GAAQX5UJ5OBPXAC264BMD5PP7OBWI\"},\"device\":{\"deviceId\":\"amzn1.ask.device.AEEQDYOJLR56EVA4KFYMAHYDWQIQ7PKMJ4IKSMUIUVH4GPKFXMOAELUIUOPU6V7SAH5R4VX4AOEYUHKPLW43KIMAEHX77FEVFK75MPPEW73UCXCLNOXBJQM3VBMYH3KSJQP64XG227F2PLD6NFKVHWP2O66BSTROSFRAYTBF44ET2V2TVFN5C\",\"supportedInterfaces\":{\"Geolocation\":{}}},\"apiEndpoint\":\"https://api.eu.amazonalexa.com\",\"apiAccessToken\":\"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IjEifQ.eyJhdWQiOiJodHRwczovL2FwaS5ldS5hbWF6b25hbGV4YS5jb20iLCJpc3MiOiJBbGV4YVNraWxsS2l0Iiwic3ViIjoiYW16bjEuYXNrLnNraWxsLjM0ODM2NDdhLWU3NjQtNGFiNS05MDBjLTdjMmMxN2U0NmIxMSIsImV4cCI6MTY2NTA4MDc1NywiaWF0IjoxNjY1MDgwNDU3LCJuYmYiOjE2NjUwODA0NTcsInByaXZhdGVDbGFpbXMiOnsiY29udGV4dCI6IkFBQUFBQUFBQVFBUytXcXJYT1BSWHJqR29UVFcvSUhHS3dFQUFBQUFBQUI0NTlYeEZZcmQ0UnMvbUdLMDd1NUV3ZVhzOEpyVEUxVlQxdDBqbVI0aDNzMTJyay9LMmdNTm1tY2I2Z0V0VXBUaEFnMzJ6c3o1UHpaWjZxSXRDSnowNnJvbUc1WHg0ZzM4RzdIelZMU3pQMUlGY295YnZqdC9kUWU0MDdrUkNRWjNmQkZiem5xTTRmRkRhNnlGZVdtY3hFNXlsTFRrbHhPZWNjV2E0M2lCZU90Ym5MNXM4L29JMVRDY05OMVhzRE02MXpULzI3cjNNcktISkd2Nk9DK2xRRXBneDlWOGNzeWVnTnNUMUlxMkhYS2hJK3ZqVkNZS0REUDdGaSt2K2dHSEdObTNOOHJ6ZlpkMk5WZU1XRWxDeVhybnkvZzI3ZEhpR2JGWmRCaWs2NmZRUHV6K0hoOFNzNU5sRnhWU25HbTlKcTR0ZmtydURBYzc4VFZZRnR0TVRpYjZMOHpoUWlrbXpUTjNuRHhDQm0yQ0w3TVNndXJVbS91YWRINER5Z2JxV2pvZnFNU05iSnRxbEE9PSIsImRldmljZUlkIjoiYW16bjEuYXNrLmRldmljZS5BRUVRRFlPSkxSNTZFVkE0S0ZZTUFIWURXUUlRN1BLTUo0SUtTTVVJVVZINEdQS0ZYTU9BRUxVSVVPUFU2VjdTQUg1UjRWWDRBT0VZVUhLUExXNDNLSU1BRUhYNzdGRVZGSzc1TVBQRVc3M1VDWENMTk9YQkpRTTNWQk1ZSDNLU0pRUDY0WEcyMjdGMlBMRDZORktWSFdQMk82NkJTVFJPU0ZSQVlUQkY0NEVUMlYyVFZGTjVDIiwidXNlcklkIjoiYW16bjEuYXNrLmFjY291bnQuQUY3S0RNR01YNVFSVzNBTDZNQkNPT0ZGUlVNWU1JN1dKUEtQNkxJNlQzSkVGNzJST0hUS01HS09NUU9BMzNDRVFCM09FQVRSTkxLR0tUWEZESVNYTkRGNlFQRDdHNzRFV0FGM05HWkhLVEdOV0Q0TktJSjRTQUVUWkZENUVQVTNaRURGR0VFQ0ZUTE43RVoyTUhMWjJUMlhaV1NLVU81SFhQVlAySUVRVzdaRUZJVUZMNUdBQVFYNVVKNU9CUFhBQzI2NEJNRDVQUDdPQldJIn19.Y_uPPN8X2IJm0tI5eJZG_IbJnfkCdTXyH9qYKcVrp95OxvtdwFQKXN1WbshGLoXAQQGvr6jkNXceG7mj3rH_7qh5Erxg1c8bXzrCbOyVui9LmP9b11RuP85ZsPL2OFA0TIiYQ-cxMPWg6DKkK2Ml9b5jMBBlvJMBYzJv7CEjGdmVuKyp_Bm5VbQlPmqvuUs6Nh3R00L7zbiH0G9D1NmDvt7gsn4Rcy_V1coRUUmtMhNbjVMUdkc54LFLfiDRwlsIx86XtlFnFCT4FtHbSLap3tvQo2Z3tXVi3J4Ks5AGg2uw4YDWkPxkkLYapxhnujujYQOPspPknoSVCKcC5E3f9g\"}},\"request\":{\"type\":\"IntentRequest\",\"requestId\":\"amzn1.echo-api.request.3b6cd82e-4026-4567-9ded-124c4bed476e\",\"locale\":\"de-DE\",\"timestamp\":\""
						+ DateTimeFormatter.ISO_INSTANT.format(Instant.now())
						+ "\",\"intent\":{\"name\":\"LightIntent\",\"confirmationStatus\":\"NONE\",\"slots\":{\"room\":{\"name\":\"room\",\"value\":\"schwarzlicht\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.ROOM\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"blacklight\",\"id\":\"blacklight\"}}]}]},\"confirmationStatus\":\"NONE\",\"source\":\"USER\",\"slotValue\":{\"type\":\"Simple\",\"value\":\"schwarzlicht\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.ROOM\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"blacklight\",\"id\":\"blacklight\"}}]}]}}},\"status\":{\"name\":\"status\",\"value\":\"an\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.STATUS\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"on\",\"id\":\"on\"}}]}]},\"confirmationStatus\":\"NONE\",\"source\":\"USER\",\"slotValue\":{\"type\":\"Simple\",\"value\":\"an\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.STATUS\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"on\",\"id\":\"on\"}}]}]}}}}}}}"))
				.andExpect(status().isOk());

		Assertions.assertThatThrownBy(() -> mvc.perform(post("/alexa")
				.contentType("application/json; charset=utf-8")
				.content("{\"version\":\"1.0\",\"session\":{\"new\":true,\"sessionId\":\"amzn1.echo-api.session.7dec95a6-a909-41ea-bf06-618abc70aba4\",\"application\":{\"applicationId\":\"amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11\"},\"attributes\":{},\"user\":{\"userId\":\"amzn1.ask.account.AF7KDMGMX5QRW3AL6MBCOOFFRUMYMI7WJPKP6LI6T3JEF72ROHTKMGKOMQOA33CEQB3OEATRNLKGKTXFDISXNDF6QPD7G74EWAF3NGZHKTGNWD4NKIJ4SAETZFD5EPU3ZEDFGEECFTLN7EZ2MHLZ2T2XZWSKUO5HXPVP2IEQW7ZEFIUFL5GAAQX5UJ5OBPXAC264BMD5PP7OBWI\"}},\"context\":{\"Viewports\":[{\"type\":\"APL\",\"id\":\"TabletFullScreen_0\",\"shape\":\"RECTANGLE\",\"dpi\":213,\"presentationType\":\"STANDARD\",\"canRotate\":true,\"configuration\":{\"current\":{\"mode\":\"MOBILE\",\"video\":{\"codecs\":[\"H_264_42\",\"H_264_41\"]},\"size\":{\"type\":\"DISCRETE\",\"pixelWidth\":800,\"pixelHeight\":1280}}}}],\"Viewport\":{\"experiences\":[{\"arcMinuteWidth\":4195,\"arcMinuteHeight\":1161,\"canRotate\":true,\"canResize\":true}],\"mode\":\"MOBILE\",\"shape\":\"RECTANGLE\",\"pixelWidth\":1280,\"pixelHeight\":800,\"dpi\":213,\"currentPixelWidth\":800,\"currentPixelHeight\":1280,\"touch\":[\"SINGLE\"],\"keyboard\":[\"DIRECTION\"],\"video\":{\"codecs\":[\"H_264_42\",\"H_264_41\"]}},\"Extensions\":{\"available\":{\"aplext:backstack:10\":{}}},\"System\":{\"application\":{\"applicationId\":\"amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11\"},\"user\":{\"userId\":\"amzn1.ask.account.AF7KDMGMX5QRW3AL6MBCOOFFRUMYMI7WJPKP6LI6T3JEF72ROHTKMGKOMQOA33CEQB3OEATRNLKGKTXFDISXNDF6QPD7G74EWAF3NGZHKTGNWD4NKIJ4SAETZFD5EPU3ZEDFGEECFTLN7EZ2MHLZ2T2XZWSKUO5HXPVP2IEQW7ZEFIUFL5GAAQX5UJ5OBPXAC264BMD5PP7OBWI\"},\"device\":{\"deviceId\":\"amzn1.ask.device.AEEQDYOJLR56EVA4KFYMAHYDWQIQ7PKMJ4IKSMUIUVH4GPKFXMOAELUIUOPU6V7SAH5R4VX4AOEYUHKPLW43KIMAEHX77FEVFK75MPPEW73UCXCLNOXBJQM3VBMYH3KSJQP64XG227F2PLD6NFKVHWP2O66BSTROSFRAYTBF44ET2V2TVFN5C\",\"supportedInterfaces\":{\"Geolocation\":{}}},\"apiEndpoint\":\"https://api.eu.amazonalexa.com\",\"apiAccessToken\":\"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IjEifQ.eyJhdWQiOiJodHRwczovL2FwaS5ldS5hbWF6b25hbGV4YS5jb20iLCJpc3MiOiJBbGV4YVNraWxsS2l0Iiwic3ViIjoiYW16bjEuYXNrLnNraWxsLjM0ODM2NDdhLWU3NjQtNGFiNS05MDBjLTdjMmMxN2U0NmIxMSIsImV4cCI6MTY2NTA4MDc1NywiaWF0IjoxNjY1MDgwNDU3LCJuYmYiOjE2NjUwODA0NTcsInByaXZhdGVDbGFpbXMiOnsiY29udGV4dCI6IkFBQUFBQUFBQVFBUytXcXJYT1BSWHJqR29UVFcvSUhHS3dFQUFBQUFBQUI0NTlYeEZZcmQ0UnMvbUdLMDd1NUV3ZVhzOEpyVEUxVlQxdDBqbVI0aDNzMTJyay9LMmdNTm1tY2I2Z0V0VXBUaEFnMzJ6c3o1UHpaWjZxSXRDSnowNnJvbUc1WHg0ZzM4RzdIelZMU3pQMUlGY295YnZqdC9kUWU0MDdrUkNRWjNmQkZiem5xTTRmRkRhNnlGZVdtY3hFNXlsTFRrbHhPZWNjV2E0M2lCZU90Ym5MNXM4L29JMVRDY05OMVhzRE02MXpULzI3cjNNcktISkd2Nk9DK2xRRXBneDlWOGNzeWVnTnNUMUlxMkhYS2hJK3ZqVkNZS0REUDdGaSt2K2dHSEdObTNOOHJ6ZlpkMk5WZU1XRWxDeVhybnkvZzI3ZEhpR2JGWmRCaWs2NmZRUHV6K0hoOFNzNU5sRnhWU25HbTlKcTR0ZmtydURBYzc4VFZZRnR0TVRpYjZMOHpoUWlrbXpUTjNuRHhDQm0yQ0w3TVNndXJVbS91YWRINER5Z2JxV2pvZnFNU05iSnRxbEE9PSIsImRldmljZUlkIjoiYW16bjEuYXNrLmRldmljZS5BRUVRRFlPSkxSNTZFVkE0S0ZZTUFIWURXUUlRN1BLTUo0SUtTTVVJVVZINEdQS0ZYTU9BRUxVSVVPUFU2VjdTQUg1UjRWWDRBT0VZVUhLUExXNDNLSU1BRUhYNzdGRVZGSzc1TVBQRVc3M1VDWENMTk9YQkpRTTNWQk1ZSDNLU0pRUDY0WEcyMjdGMlBMRDZORktWSFdQMk82NkJTVFJPU0ZSQVlUQkY0NEVUMlYyVFZGTjVDIiwidXNlcklkIjoiYW16bjEuYXNrLmFjY291bnQuQUY3S0RNR01YNVFSVzNBTDZNQkNPT0ZGUlVNWU1JN1dKUEtQNkxJNlQzSkVGNzJST0hUS01HS09NUU9BMzNDRVFCM09FQVRSTkxLR0tUWEZESVNYTkRGNlFQRDdHNzRFV0FGM05HWkhLVEdOV0Q0TktJSjRTQUVUWkZENUVQVTNaRURGR0VFQ0ZUTE43RVoyTUhMWjJUMlhaV1NLVU81SFhQVlAySUVRVzdaRUZJVUZMNUdBQVFYNVVKNU9CUFhBQzI2NEJNRDVQUDdPQldJIn19.Y_uPPN8X2IJm0tI5eJZG_IbJnfkCdTXyH9qYKcVrp95OxvtdwFQKXN1WbshGLoXAQQGvr6jkNXceG7mj3rH_7qh5Erxg1c8bXzrCbOyVui9LmP9b11RuP85ZsPL2OFA0TIiYQ-cxMPWg6DKkK2Ml9b5jMBBlvJMBYzJv7CEjGdmVuKyp_Bm5VbQlPmqvuUs6Nh3R00L7zbiH0G9D1NmDvt7gsn4Rcy_V1coRUUmtMhNbjVMUdkc54LFLfiDRwlsIx86XtlFnFCT4FtHbSLap3tvQo2Z3tXVi3J4Ks5AGg2uw4YDWkPxkkLYapxhnujujYQOPspPknoSVCKcC5E3f9g\"}},\"request\":{\"type\":\"IntentRequest\",\"requestId\":\"amzn1.echo-api.request.3b6cd82e-4026-4567-9ded-124c4bed476e\",\"locale\":\"de-DE\",\"timestamp\":\""
						+ DateTimeFormatter.ISO_INSTANT.format(Instant.now().minusSeconds(60))
						+ "\",\"intent\":{\"name\":\"LightIntent\",\"confirmationStatus\":\"NONE\",\"slots\":{\"room\":{\"name\":\"room\",\"value\":\"schwarzlicht\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.ROOM\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"blacklight\",\"id\":\"blacklight\"}}]}]},\"confirmationStatus\":\"NONE\",\"source\":\"USER\",\"slotValue\":{\"type\":\"Simple\",\"value\":\"schwarzlicht\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.ROOM\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"blacklight\",\"id\":\"blacklight\"}}]}]}}},\"status\":{\"name\":\"status\",\"value\":\"an\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.STATUS\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"on\",\"id\":\"on\"}}]}]},\"confirmationStatus\":\"NONE\",\"source\":\"USER\",\"slotValue\":{\"type\":\"Simple\",\"value\":\"an\",\"resolutions\":{\"resolutionsPerAuthority\":[{\"authority\":\"amzn1.er-authority.echo-sdk.amzn1.ask.skill.3483647a-e764-4ab5-900c-7c2c17e46b11.STATUS\",\"status\":{\"code\":\"ER_SUCCESS_MATCH\"},\"values\":[{\"value\":{\"name\":\"on\",\"id\":\"on\"}}]}]}}}}}}}")))
				.isInstanceOf(NestedServletException.class)
				.getCause()
				.isInstanceOf(SecurityException.class)
				.hasMessageContaining("failed timestamp validation");
	}
}
